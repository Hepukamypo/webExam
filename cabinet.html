<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет - LinguaSphere</title>
    <!-- Подключение Bootstrap 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Подключение Font Awesome для иконок -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Подключение кастомных стилей -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/notifications.css">
</head>
<body>
    <!-- Шапка сайта -->
    <header class="sticky-top">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center" href="index.html">
                    <img src="assets/images/logo.png" alt="LinguaSphere" width="40" height="40" class="me-2">
                    <span>LinguaSphere</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">Главная</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="index.html#courses">Курсы</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="index.html#about">О нас</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="index.html#contacts">Контакты</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="cabinet.html">Личный кабинет</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        
        <!-- Область уведомлений -->
        <div id="notifications-container" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>
    </header>

    <!-- Заголовок страницы -->
    <section class="py-5 bg-light">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <h1 class="display-4 fw-bold">Личный кабинет</h1>
                    <p class="lead text-muted">Управляйте вашими заявками на обучение</p>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#orderModal">
                        <i class="fas fa-plus me-2"></i>Новая заявка
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Таблица заявок -->
    <section class="py-5">
        <div class="container">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Мои заявки</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Название</th>
                                    <th scope="col">Тип</th>
                                    <th scope="col">Дата занятия</th>
                                    <th scope="col">Стоимость</th>
                                    <th scope="col">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <!-- Заявки будут загружены динамически -->
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Загрузка...</span>
                                        </div>
                                        <p class="mt-3 text-muted">Загрузка списка заявок...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="emptyOrdersMessage" class="text-center py-5 d-none">
                        <i class="fas fa-clipboard-list fs-1 text-muted mb-3"></i>
                        <h4 class="mb-3">У вас пока нет заявок</h4>
                        <p class="text-muted mb-4">Создайте первую заявку для записи на языковой курс или индивидуальные занятия с репетитором</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#orderModal">
                            <i class="fas fa-plus me-2"></i>Создать заявку
                        </button>
                    </div>
                    
                    <!-- Пагинация заявок -->
                    <nav aria-label="Pagination for orders">
                        <ul id="ordersPagination" class="pagination justify-content-center mt-4">
                            <!-- Пагинация будет сгенерирована динамически -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </section>

    <!-- Модальное окно для деталей заявки -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDetailsModalLabel">Детали заявки</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body">
                    <div id="orderDetailsContent">
                        <!-- Контент будет загружен динамически -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для редактирования заявки -->
    <div class="modal fade" id="editOrderModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editOrderModalLabel">Редактирование заявки</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body">
                    <form id="editOrderForm">
                        <input type="hidden" id="editOrderId">
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Тип заявки</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="editOrderType" id="editCourseOrder" value="course" checked disabled>
                                <label class="form-check-label" for="editCourseOrder">Языковой курс</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="editOrderType" id="editTutorOrder" value="tutor" disabled>
                                <label class="form-check-label" for="editTutorOrder">Индивидуальные занятия с репетитором</label>
                            </div>
                        </div>
                        
                        <div id="editCourseSection">
                            <div class="mb-3">
                                <label for="editCourseName" class="form-label">Название курса</label>
                                <input type="text" class="form-control" id="editCourseName" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label for="editTeacherName" class="form-label">Преподаватель</label>
                                <input type="text" class="form-control" id="editTeacherName" readonly>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="editStartDate" class="form-label">Дата начала</label>
                                    <select class="form-select" id="editStartDate" required>
                                        <option value="">Выберите дату</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="editStartTime" class="form-label">Время занятий</label>
                                    <select class="form-select" id="editStartTime" disabled required>
                                        <option value="">Сначала выберите дату</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Продолжительность курса</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="editCourseDuration" readonly>
                                    <span class="input-group-text">недель</span>
                                </div>
                                <div class="form-text">Ориентировочная дата окончания: <span id="editEndDate"></span></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editStudentsNumber" class="form-label">Количество студентов</label>
                            <input type="number" class="form-control" id="editStudentsNumber" min="1" max="20" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Дополнительные опции</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="editSupplementary" value="1">
                                        <label class="form-check-label" for="editSupplementary">
                                            Дополнительные материалы
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="editPersonalized" value="1">
                                        <label class="form-check-label" for="editPersonalized">
                                            Индивидуальные занятия
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="editAssessment" value="1">
                                        <label class="form-check-label" for="editAssessment">
                                            Оценка уровня
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="editExcursions" value="1">
                                        <label class="form-check-label" for="editExcursions">
                                            Культурные экскурсии
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="editInteractive" value="1">
                                        <label class="form-check-label" for="editInteractive">
                                            Доступ к онлайн-платформе
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3 p-3 bg-light rounded">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Общая стоимость:</h5>
                                <h3 class="mb-0 text-primary" id="editTotalPrice">0 ₽</h3>
                            </div>
                            <div class="mt-2" id="editPriceBreakdown"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="saveOrderChanges">Сохранить изменения</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно подтверждения удаления -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Подтверждение удаления</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body">
                    <p>Вы уверены, что хотите удалить эту заявку?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Нет</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Да, удалить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Футер -->
    <footer class="bg-dark text-white py-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4 mb-lg-0">
                    <div class="d-flex align-items-center mb-3">
                        <img src="assets/images/logo.png" alt="LinguaSphere" width="40" height="40" class="me-2">
                        <h3 class="mb-0">LinguaSphere</h3>
                    </div>
                    <p>Профессиональная языковая школа с индивидуальным подходом к каждому студенту. Мы помогаем осваивать языки с 2010 года.</p>
                    <div class="d-flex mt-3">
                        <a href="#" class="text-white me-3"><i class="fab fa-facebook-f fs-5"></i></a>
                        <a href="#" class="text-white me-3"><i class="fab fa-instagram fs-5"></i></a>
                        <a href="#" class="text-white me-3"><i class="fab fa-telegram fs-5"></i></a>
                        <a href="#" class="text-white"><i class="fab fa-vk fs-5"></i></a>
                    </div>
                </div>
                <div class="col-lg-4 mb-4 mb-lg-0">
                    <h4 class="mb-4">Полезные ссылки</h4>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="index.html" class="text-white text-decoration-none">Главная страница</a></li>
                        <li class="mb-2"><a href="index.html#courses" class="text-white text-decoration-none">Наши курсы</a></li>
                        <li class="mb-2"><a href="index.html#about" class="text-white text-decoration-none">О нас</a></li>
                        <li class="mb-2"><a href="index.html#contacts" class="text-white text-decoration-none">Контакты</a></li>
                        <li class="mb-2"><a href="cabinet.html" class="text-white text-decoration-none">Личный кабинет</a></li>
                    </ul>
                </div>
                <div class="col-lg-4">
                    <h4 class="mb-4">Контакты</h4>
                    <ul class="list-unstyled">
                        <li class="mb-2 d-flex"><i class="fas fa-map-marker-alt mt-1 me-2"></i> <span>г. Москва, ул. Лингвистическая, д. 15</span></li>
                        <li class="mb-2 d-flex"><i class="fas fa-phone mt-1 me-2"></i> <span>+7 (495) 123-45-67</span></li>
                        <li class="mb-2 d-flex"><i class="fas fa-envelope mt-1 me-2"></i> <span>info@linguasphere.ru</span></li>
                        <li class="mb-2 d-flex"><i class="fas fa-clock mt-1 me-2"></i> <span>Пн-Пт: 9:00-21:00, Сб: 10:00-18:00</span></li>
                    </ul>
                </div>
            </div>
            <hr class="my-4 bg-secondary">
            <div class="text-center">
                <p class="mb-0">&copy; 2026 LinguaSphere. Все права защищены.</p>
            </div>
        </div>
    </footer>

    <!-- Подключение JavaScript -->
    <script>
        // ОБЯЗАТЕЛЬНО: API_KEY объявлен только здесь, в cabinet.html
        const API_KEY = '043f7d68-3cee-44dd-9ba1-bfed45a44f99';
        const API_BASE_URL = 'http://exam-api-courses.std-900.ist.mospolytech.ru';
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/orders.js"></script>
    <script src="assets/js/calculator.js"></script>
    <script src="assets/js/notifications.js"></script>
    <script src="assets/js/pagination.js"></script>
    <script>
        // Глобальные переменные для пагинации
        let orders = [];
        let currentPage = 1;
        const ordersPerPage = 5;
        
        // Проверка API ключа при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            if (API_KEY === 'ВАШ_API_КЛЮЧ' || !API_KEY) {
                console.error('ПРЕДУПРЕЖДЕНИЕ: API ключ не установлен! Получите реальный ключ в СДО Московского Политеха.');
                showNotification('API ключ не установлен. Получите ключ в СДО Московского Политеха.', 'warning');
            } else {
                console.log('API ключ установлен:', API_KEY.substring(0, 8) + '...');
            }
            
            // Загрузка заявок пользователя
            loadUserOrders();
            
            // Инициализация обработчиков событий
            document.getElementById('saveOrderChanges').addEventListener('click', saveOrderChanges);
            document.getElementById('confirmDelete').addEventListener('click', confirmDeleteOrder);
        });
        
        function loadUserOrders() {
            showLoader('ordersTableBody', 6);
            
            const url = `${API_BASE_URL}/api/orders?api_key=${API_KEY}`;
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || 'Ошибка загрузки данных');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    orders = data;
                    renderOrdersTable();
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    showApiError(error);
                    renderEmptyOrdersTable();
                });
        }
        
        function renderOrdersTable() {
            const tableBody = document.getElementById('ordersTableBody');
            const emptyMessage = document.getElementById('emptyOrdersMessage');
            
            if (orders.length === 0) {
                emptyMessage.classList.remove('d-none');
                tableBody.innerHTML = '';
                document.getElementById('ordersPagination').innerHTML = '';
                return;
            }
            
            emptyMessage.classList.add('d-none');
            
            // Пагинация
            const totalPages = Math.ceil(orders.length / ordersPerPage);
            const startIndex = (currentPage - 1) * ordersPerPage;
            const currentOrders = orders.slice(startIndex, startIndex + ordersPerPage);
            
            // Отрисовка таблицы
            let html = '';
            currentOrders.forEach((order, index) => {
                const rowNumber = startIndex + index + 1;
                const orderType = order.course_id ? 'Курс' : 'Репетитор';
                const courseName = order.course_id ? order.course_name : order.tutor_name;
                const date = order.date_start;
                const price = order.price.toLocaleString('ru-RU') + ' ₽';
                
                html += `
                    <tr>
                        <td>${rowNumber}</td>
                        <td>${courseName}</td>
                        <td>${orderType}</td>
                        <td>${formatDate(date)}</td>
                        <td>${price}</td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-info text-white" title="Подробнее" onclick="showOrderDetails(${order.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" title="Изменить" onclick="editOrder(${order.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" title="Удалить" onclick="deleteOrder(${order.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            
            // Генерация пагинации
            generatePagination('ordersPagination', totalPages, currentPage, setPage);
        }
        
        function renderEmptyOrdersTable() {
            document.getElementById('ordersTableBody').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-5">
                        <i class="fas fa-clipboard-list fs-1 text-muted mb-3"></i>
                        <h4>У вас пока нет заявок</h4>
                        <p class="text-muted mb-4">Создайте первую заявку для записи на языковой курс или индивидуальные занятия с репетитором</p>
                    </td>
                </tr>
            `;
            document.getElementById('emptyOrdersMessage').classList.remove('d-none');
            document.getElementById('ordersPagination').innerHTML = '';
        }
        
        function setPage(page) {
            currentPage = page;
            renderOrdersTable();
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        function showLoader(containerId, colSpan) {
            document.getElementById(containerId).innerHTML = `
                <tr>
                    <td colspan="${colSpan}" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-3 text-muted">Загрузка данных...</p>
                    </td>
                </tr>
            `;
        }
        
        function showOrderDetails(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            let content = `
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h4 class="mb-3">Основная информация</h4>
                        <p><strong>Тип заявки:</strong> ${order.course_id ? 'Языковой курс' : 'Индивидуальные занятия'}</p>
                        <p><strong>Название:</strong> ${order.course_id ? order.course_name : order.tutor_name}</p>
                        <p><strong>Дата начала:</strong> ${formatDate(order.date_start)}</p>
                        <p><strong>Время:</strong> ${order.time_start}</p>
                        <p><strong>Количество студентов:</strong> ${order.persons}</p>
                        <p><strong>Продолжительность:</strong> ${order.duration} ${order.course_id ? 'недель' : 'часов'}</p>
                    </div>
                    <div class="col-md-6">
                        <h4 class="mb-3">Финансовая информация</h4>
                        <p><strong>Базовая стоимость:</strong> ${(order.price).toLocaleString('ru-RU')} ₽</p>
                        ${order.early_registration ? '<p class="text-success"><i class="fas fa-tag me-2"></i>Применена скидка за раннюю регистрацию (-10%)</p>' : ''}
                        ${order.group_enrollment ? '<p class="text-success"><i class="fas fa-users me-2"></i>Применена скидка за групповую запись (-15%)</p>' : ''}
                        ${order.intensive_course ? '<p class="text-warning"><i class="fas fa-bolt me-2"></i>Доплата за интенсивный курс (+20%)</p>' : ''}
                    </div>
                </div>
                <div class="mb-4">
                    <h4 class="mb-3">Дополнительные опции</h4>
                    <div class="row">
            `;
            
            const options = [
                { field: 'supplementary', label: 'Дополнительные материалы', price: 2000 * order.persons },
                { field: 'personalized', label: 'Индивидуальные занятия', price: 1500 * (order.course_id ? order.total_length : order.duration) },
                { field: 'excursions', label: 'Культурные экскурсии', price: order.price * 0.25 },
                { field: 'assessment', label: 'Оценка уровня', price: 300 },
                { field: 'interactive', label: 'Доступ к онлайн-платформе', price: order.price * 0.5 }
            ];
            
            options.forEach(option => {
                if (order[option.field]) {
                    content += `
                        <div class="col-md-4 mb-2">
                            <div class="border p-2 rounded">
                                <p class="mb-1"><strong>${option.label}</strong></p>
                                <p class="mb-0 text-primary">+ ${Math.round(option.price).toLocaleString('ru-RU')} ₽</p>
                            </div>
                        </div>
                    `;
                }
            });
            
            content += `
                    </div>
                </div>
                <div class="alert alert-primary">
                    <h5 class="mb-2">Итоговая стоимость: ${(order.price).toLocaleString('ru-RU')} ₽</h5>
                    ${order.early_registration || order.group_enrollment ? '<p class="mb-0"><small>* Скидки уже применены в итоговой стоимости</small></p>' : ''}
                </div>
            `;
            
            document.getElementById('orderDetailsContent').innerHTML = content;
            const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            modal.show();
        }
        
        function editOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            // Заполнение формы данными заявки
            document.getElementById('editOrderId').value = order.id;
            document.getElementById('editStudentsNumber').value = order.persons;
            
            // Установка дополнительных опций
            document.getElementById('editSupplementary').checked = order.supplementary;
            document.getElementById('editPersonalized').checked = order.personalized;
            document.getElementById('editExcursions').checked = order.excursions;
            document.getElementById('editAssessment').checked = order.assessment;
            document.getElementById('editInteractive').checked = order.interactive;
            
            // Если это курс
            if (order.course_id) {
                document.getElementById('editCourseOrder').checked = true;
                document.getElementById('editCourseSection').classList.remove('d-none');
                
                // Загрузка информации о курсе для заполнения формы
                fetch(`${API_BASE_URL}/api/courses/${order.course_id}?api_key=${API_KEY}`)
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => {
                                throw new Error(data.error || 'Ошибка загрузки данных');
                            });
                        }
                        return response.json();
                    })
                    .then(course => {
                        document.getElementById('editCourseName').value = course.name;
                        document.getElementById('editTeacherName').value = course.teacher;
                        document.getElementById('editCourseDuration').value = course.total_length;
                        
                        // Заполнение дат начала
                        const dateSelect = document.getElementById('editStartDate');
                        dateSelect.innerHTML = '<option value="">Выберите дату</option>';
                        course.start_dates.forEach(date => {
                            const option = document.createElement('option');
                            option.value = date.split('T')[0]; // Только дата
                            option.textContent = new Date(date).toLocaleDateString('ru-RU');
                            if (date.split('T')[0] === order.date_start) {
                                option.selected = true;
                            }
                            dateSelect.appendChild(option);
                        });
                        
                        // Активация селекта времени при выборе даты
                        dateSelect.addEventListener('change', function() {
                            updateEditTimeOptions(course, this.value);
                        });
                        
                        // Если дата уже выбрана, обновляем время
                        if (order.date_start) {
                            updateEditTimeOptions(course, order.date_start);
                            
                            // Устанавливаем выбранное время
                            const timeSelect = document.getElementById('editStartTime');
                            for (let i = 0; i < timeSelect.options.length; i++) {
                                if (timeSelect.options[i].value === order.time_start) {
                                    timeSelect.selectedIndex = i;
                                    break;
                                }
                            }
                        }
                        
                        // Первоначальный расчет цены
                        updateEditPriceCalculation(course);
                    })
                    .catch(error => {
                        console.error('Ошибка:', error);
                        showApiError(error);
                    });
            } else {
                // Если это репетитор
                document.getElementById('editTutorOrder').checked = true;
                document.getElementById('editCourseSection').classList.add('d-none');
                
                // Загрузка информации о репетиторе
                fetch(`${API_BASE_URL}/api/tutors/${order.tutor_id}?api_key=${API_KEY}`)
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => {
                                throw new Error(data.error || 'Ошибка загрузки данных');
                            });
                        }
                        return response.json();
                    })
                    .then(tutor => {
                        document.getElementById('editCourseName').value = tutor.name;
                    })
                    .catch(error => {
                        console.error('Ошибка:', error);
                        showApiError(error);
                    });
            }
            
            const modal = new bootstrap.Modal(document.getElementById('editOrderModal'));
            modal.show();
        }
        
        function updateEditTimeOptions(course, selectedDate) {
            const timeSelect = document.getElementById('editStartTime');
            timeSelect.innerHTML = '';
            timeSelect.disabled = false;
            
            // Фильтрация времени для выбранной даты
            const availableTimes = course.start_dates
                .filter(dateStr => dateStr.startsWith(selectedDate))
                .map(dateStr => dateStr.split('T')[1].substring(0, 5));
            
            if (availableTimes.length === 0) {
                timeSelect.innerHTML = '<option value="">Нет доступного времени</option>';
                timeSelect.disabled = true;
                return;
            }
            
            availableTimes.forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                timeSelect.appendChild(option);
            });
        }
        
        function updateEditPriceCalculation(course) {
            const studentsNumber = parseInt(document.getElementById('editStudentsNumber').value) || 1;
            const startDate = document.getElementById('editStartDate').value;
            const startTime = document.getElementById('editStartTime').value;
            const supplementary = document.getElementById('editSupplementary').checked;
            const personalized = document.getElementById('editPersonalized').checked;
            const excursions = document.getElementById('editExcursions').checked;
            const assessment = document.getElementById('editAssessment').checked;
            const interactive = document.getElementById('editInteractive').checked;
            
            if (!course || !startDate || !startTime) {
                document.getElementById('editTotalPrice').textContent = '0 ₽';
                document.getElementById('editPriceBreakdown').innerHTML = '';
                return;
            }
            
            // Расчет стоимости
            const result = calculateCoursePrice(
                course, 
                startDate, 
                startTime, 
                studentsNumber,
                supplementary,
                personalized,
                excursions,
                assessment,
                interactive
            );
            
            // Отображение результата
            document.getElementById('editTotalPrice').textContent = result.totalPrice.toLocaleString('ru-RU') + ' ₽';
            document.getElementById('editPriceBreakdown').innerHTML = result.breakdownHtml;
            
            // Обновление даты окончания
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + course.total_length * 7);
            document.getElementById('editEndDate').textContent = endDate.toLocaleDateString('ru-RU');
        }
        
        function deleteOrder(orderId) {
            window.currentDeleteOrderId = orderId;
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }
        
        function confirmDeleteOrder() {
            const orderId = window.currentDeleteOrderId;
            if (!orderId) return;
            
            const url = `${API_BASE_URL}/api/orders/${orderId}?api_key=${API_KEY}`;
            
            fetch(url, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Ошибка при удалении заявки');
                    });
                }
                return response.json();
            })
            .then(() => {
                showNotification('Заявка успешно удалена', 'success');
                loadUserOrders();
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                modal.hide();
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showApiError(error);
            });
        }
        
        function saveOrderChanges() {
            const orderId = document.getElementById('editOrderId').value;
            const studentsNumber = document.getElementById('editStudentsNumber').value;
            const startDate = document.getElementById('editStartDate').value;
            const startTime = document.getElementById('editStartTime').value;
            const supplementary = document.getElementById('editSupplementary').checked;
            const personalized = document.getElementById('editPersonalized').checked;
            const excursions = document.getElementById('editExcursions').checked;
            const assessment = document.getElementById('editAssessment').checked;
            const interactive = document.getElementById('editInteractive').checked;
            
            // Определяем продолжительность
            let duration = 0;
            const order = orders.find(o => o.id === parseInt(orderId));
            
            if (order.course_id) {
                // Для курса - берем продолжительность из данных курса
                const course = allCourses.find(c => c.id === order.course_id);
                if (course) {
                    duration = course.total_length;
                }
            } else {
                // Для репетитора - берем из формы (если есть поле duration)
                duration = parseInt(document.getElementById('editDurationHours')?.value) || 1;
            }
            
            // Расчет цены для отправки на сервер
            const totalPrice = parseInt(document.getElementById('editTotalPrice').textContent.replace(/\D/g, ''));
            
            const data = {
                persons: parseInt(studentsNumber),
                duration: duration, // ДОБАВЛЕНО поле duration
                date_start: startDate,
                time_start: startTime,
                supplementary: supplementary,
                personalized: personalized,
                excursions: excursions,
                assessment: assessment,
                interactive: interactive,
                price: totalPrice
            };
            
            // Если это курс, добавляем ID курса
            if (order.course_id) {
                data.course_id = order.course_id;
            } else {
                data.tutor_id = order.tutor_id;
            }
            
            const url = `${API_BASE_URL}/api/orders/${orderId}?api_key=${API_KEY}`;
            
            fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Ошибка при обновлении заявки');
                    });
                }
                return response.json();
            })
            .then(() => {
                showNotification('Заявка успешно обновлена', 'success');
                loadUserOrders();
                const modal = bootstrap.Modal.getInstance(document.getElementById('editOrderModal'));
                modal.hide();
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showApiError(error);
            });
        }
        
        // Добавляем функции в глобальную область видимости для вызова из HTML
        window.showOrderDetails = showOrderDetails;
        window.editOrder = editOrder;
        window.deleteOrder = deleteOrder;
        
        // Добавляем обработку ошибок API
        window.addEventListener('unhandledrejection', event => {
            console.error('Необработанное обещание:', event.reason);
            showNotification('Произошла ошибка: ' + event.reason.message, 'danger');
			
        });
    </script>
</body>
</html>